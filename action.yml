name: 'Uptool Dependency Updater'
description: 'Universal manifest-first dependency updater for npm, Helm, Terraform, pre-commit, and more'
author: 'santosr2'

branding:
  icon: 'package'
  color: 'blue'

inputs:
  command:
    description: 'Command to run: scan, plan, or update'
    required: false
    default: 'plan'

  format:
    description: 'Output format: table or json'
    required: false
    default: 'table'

  only:
    description: 'Comma-separated list of integrations to include (e.g., npm,helm)'
    required: false
    default: ''

  exclude:
    description: 'Comma-separated list of integrations to exclude'
    required: false
    default: ''

  dry-run:
    description: 'Show changes without applying (for update command)'
    required: false
    default: 'false'

  diff:
    description: 'Show diffs of changes (for update command)'
    required: false
    default: 'true'

  create-pr:
    description: 'Create a pull request with updates'
    required: false
    default: 'false'

  pr-title:
    description: 'Title for the pull request'
    required: false
    default: 'chore: update dependencies'

  pr-branch:
    description: 'Branch name for the pull request'
    required: false
    default: 'uptool/dependency-updates'

  token:
    description: 'GitHub token for creating PRs'
    required: false
    default: ${{ github.token }}

outputs:
  updates-available:
    description: 'Whether updates are available (true/false)'
    value: ${{ steps.uptool.outputs.updates-available }}

  manifests-updated:
    description: 'Number of manifests updated'
    value: ${{ steps.uptool.outputs.manifests-updated }}

  dependencies-updated:
    description: 'Number of dependencies updated'
    value: ${{ steps.uptool.outputs.dependencies-updated }}

runs:
  using: 'composite'
  steps:
    - name: Setup Go
      uses: actions/setup-go@3041bf56c941b39c61721a86cd11f3bb1338122a # v5.2.0
      with:
        go-version: '1.23'
        cache: false

    - name: Install uptool
      shell: bash
      run: |
        cd ${{ github.action_path }}
        go build -o /tmp/uptool ./cmd/uptool
        chmod +x /tmp/uptool

    - name: Run uptool
      id: uptool
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.token }}
      run: |
        CMD="${{ inputs.command }}"
        ARGS=""

        # Add format flag
        if [ "$CMD" != "update" ] && [ -n "${{ inputs.format }}" ]; then
          ARGS="$ARGS --format=${{ inputs.format }}"
        fi

        # Add only flag
        if [ -n "${{ inputs.only }}" ]; then
          ARGS="$ARGS --only=${{ inputs.only }}"
        fi

        # Add exclude flag
        if [ -n "${{ inputs.exclude }}" ]; then
          ARGS="$ARGS --exclude=${{ inputs.exclude }}"
        fi

        # Add update-specific flags
        if [ "$CMD" == "update" ]; then
          if [ "${{ inputs.dry-run }}" == "true" ]; then
            ARGS="$ARGS --dry-run"
          fi
          if [ "${{ inputs.diff }}" == "true" ]; then
            ARGS="$ARGS --diff"
          fi
        fi

        # Run uptool
        echo "Running: /tmp/uptool $CMD $ARGS"
        /tmp/uptool $CMD $ARGS | tee /tmp/uptool-output.txt
        EXIT_CODE=${PIPESTATUS[0]}

        # Parse output to set outputs
        if grep -q "No updates available" /tmp/uptool-output.txt || grep -q "No manifests found" /tmp/uptool-output.txt; then
          echo "updates-available=false" >> $GITHUB_OUTPUT
          echo "manifests-updated=0" >> $GITHUB_OUTPUT
          echo "dependencies-updated=0" >> $GITHUB_OUTPUT
        else
          echo "updates-available=true" >> $GITHUB_OUTPUT

          # Extract counts from output
          MANIFESTS=$(grep -oP 'Total: \K\d+(?= updates across \d+ manifests)' /tmp/uptool-output.txt || echo "0")
          DEPS=$(grep -oP 'Applied: \K\d+' /tmp/uptool-output.txt | awk '{s+=$1} END {print s}' || echo "0")

          echo "manifests-updated=$MANIFESTS" >> $GITHUB_OUTPUT
          echo "dependencies-updated=$DEPS" >> $GITHUB_OUTPUT
        fi

        exit $EXIT_CODE

    - name: Generate detailed PR body
      if: inputs.create-pr == 'true' && steps.uptool.outputs.updates-available == 'true'
      id: pr-body
      shell: bash
      run: |
        # Run uptool plan with JSON output to get detailed update information
        /tmp/uptool plan --format=json > /tmp/plan-output.json

        # Generate PR body with detailed information
        cat > /tmp/pr-body.md <<'EOFMARKER'
        ## ğŸ“¦ Dependency Updates

        This PR updates dependencies to their latest versions.

        EOFMARKER

        # Parse JSON and create detailed tables per manifest
        jq -r '
          .plans[] |
          "### " + (.manifest.path | gsub("^\\./"; "")) + "\n\n" +
          "| Package | Update | Type | Links |\n" +
          "|---------|--------|------|-------|\n" +
          (
            .updates[] |
            "| **" + .dependency.name + "** | `" + .dependency.current_version + "` â†’ `" + .target_version + "` | " +
            (if .impact == "major" then "ğŸ”´ Major"
             elif .impact == "minor" then "ğŸŸ¡ Minor"
             elif .impact == "patch" then "ğŸŸ¢ Patch"
             else "âšª " + .impact end) +
            " | " +
            (if .changelog_url != "" and .changelog_url != null then
              "[Changelog](" + .changelog_url + ")"
             else
              "N/A"
             end) +
            " |\n"
          ) +
          "\n"
        ' /tmp/plan-output.json >> /tmp/pr-body.md

        # Add update statistics
        TOTAL_UPDATES=$(jq '[.plans[].updates[]] | length' /tmp/plan-output.json)
        MANIFEST_COUNT=$(jq '[.plans[]] | length' /tmp/plan-output.json)
        MAJOR_COUNT=$(jq '[.plans[].updates[] | select(.impact == "major")] | length' /tmp/plan-output.json)
        MINOR_COUNT=$(jq '[.plans[].updates[] | select(.impact == "minor")] | length' /tmp/plan-output.json)
        PATCH_COUNT=$(jq '[.plans[].updates[] | select(.impact == "patch")] | length' /tmp/plan-output.json)

        cat >> /tmp/pr-body.md <<EOFMARKER

        ---

        ### ğŸ“Š Update Summary

        - **Total updates:** $TOTAL_UPDATES
        - **Manifests affected:** $MANIFEST_COUNT
        - **Update types:** ğŸ”´ $MAJOR_COUNT major Â· ğŸŸ¡ $MINOR_COUNT minor Â· ğŸŸ¢ $PATCH_COUNT patch

        <details>
        <summary>â„¹ï¸ <strong>Update Type Definitions</strong></summary>

        - ğŸ”´ **Major** - Breaking changes may be introduced
        - ğŸŸ¡ **Minor** - New features, backwards compatible
        - ğŸŸ¢ **Patch** - Bug fixes and minor improvements

        </details>

        ### âœ… Checklist

        - [ ] Review all dependency changes
        - [ ] Check for breaking changes (especially major updates)
        - [ ] Verify tests pass
        - [ ] Update documentation if needed
        - [ ] Test in staging/development environment

        ### ğŸ”— Resources

        - [uptool Documentation](https://github.com/santosr2/uptool)
        - [Manifest-First Philosophy](https://github.com/santosr2/uptool#manifest-first)

        ---

        <sub>ğŸ¤– This PR was automatically generated by [uptool](https://github.com/santosr2/uptool)</sub>
        EOFMARKER

        # Output the PR body for the next step (escape for GitHub Actions)
        {
          echo 'pr-body<<EOF_PR_BODY_DELIMITER'
          cat /tmp/pr-body.md
          echo 'EOF_PR_BODY_DELIMITER'
        } >> $GITHUB_OUTPUT

    - name: Create Pull Request
      if: inputs.create-pr == 'true' && steps.uptool.outputs.updates-available == 'true'
      uses: peter-evans/create-pull-request@c5a7806660adbe173f04e3e038b0ccdcd758773c # v7.0.5
      with:
        token: ${{ inputs.token }}
        commit-message: ${{ inputs.pr-title }}
        title: ${{ inputs.pr-title }}
        branch: ${{ inputs.pr-branch }}
        body: ${{ steps.pr-body.outputs.pr-body }}
        labels: |
          dependencies
          automated
