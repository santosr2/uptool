name: Verify Signed Commits

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  verify-commits:
    name: Verify Commit Signatures
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Verify commit signatures
        id: verify
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          {
            echo "## üîê Commit Signature Verification"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # Get commits from PR
            BASE_REF="${{ github.event.pull_request.base.sha }}"
            HEAD_REF="${{ github.event.pull_request.head.sha }}"
            COMMITS=$(git log --pretty=format:"%H" "$BASE_REF".."$HEAD_REF")
          else
            # Get recent commits from push
            COMMITS=$(git log --pretty=format:"%H" -n 10)
          fi

          TOTAL=0
          SIGNED=0
          UNSIGNED=0
          UNSIGNED_COMMITS=""

          while IFS= read -r commit; do
            if [ -z "$commit" ]; then
              continue
            fi

            TOTAL=$((TOTAL+1))

            AUTHOR=$(git log -1 --pretty=format:"%an <%ae>" "$commit")
            MESSAGE=$(git log -1 --pretty=format:"%s" "$commit")
            SHORT_SHA="${commit:0:7}"

            # Check multiple signature types:
            # 1. GPG signature (traditional)
            # 2. SSH signature (newer)
            # 3. GitHub web-based signature

            IS_SIGNED=false
            SIG_TYPE=""

            # Try GPG verification first
            if git verify-commit "$commit" 2>&1 | grep -q "Good signature\|valid signature"; then
              IS_SIGNED=true
              SIG_TYPE="GPG"
            # Try SSH signature check
            elif git log --format="%G?" -1 "$commit" | grep -q "G\|U"; then
              # G = good signature, U = good signature with unknown validity
              IS_SIGNED=true
              SIG_TYPE="SSH/GPG"
            # Check for any signature using git show
            elif git show --show-signature --no-patch "$commit" 2>&1 | \
                 grep -Eq "Signature made|Good signature|gpg: Signature|ssh: Signature|SSH:"; then
              IS_SIGNED=true
              SIG_TYPE="SSH/GPG"
            # Check via GitHub API for web-based signatures
            elif gh api "/repos/${{ github.repository }}/commits/$commit" \
                 --jq '.commit.verification.verified' 2>/dev/null | grep -q "true"; then
              IS_SIGNED=true
              SIG_TYPE="GitHub"
            fi

            if [ "$IS_SIGNED" = true ]; then
              echo "‚úÖ **Signed ($SIG_TYPE)**: \`$SHORT_SHA\` - $MESSAGE" >> "$GITHUB_STEP_SUMMARY"
              SIGNED=$((SIGNED+1))
            else
              echo "‚ùå **Unsigned**: \`$SHORT_SHA\` - $MESSAGE (by $AUTHOR)" >> "$GITHUB_STEP_SUMMARY"
              UNSIGNED=$((UNSIGNED+1))
              UNSIGNED_COMMITS="$UNSIGNED_COMMITS\n- $SHORT_SHA: $MESSAGE"
            fi
          done <<< "$COMMITS"

          {
            echo ""
            echo "### Summary"
            echo "- **Total commits checked**: $TOTAL"
            echo "- **Signed commits**: $SIGNED"
            echo "- **Unsigned commits**: $UNSIGNED"
          } >> "$GITHUB_STEP_SUMMARY"

          if [ "$TOTAL" -gt 0 ]; then
            PERCENTAGE=$((SIGNED * 100 / TOTAL))
            echo "- **Signature coverage**: ${PERCENTAGE}%" >> "$GITHUB_STEP_SUMMARY"
          fi

          {
            echo ""
            echo "### ‚ÑπÔ∏è About Commit Signing"
            echo ""
            echo "Signed commits provide cryptographic proof of authorship and integrity."
            echo ""
            echo "**Supported signature types**: GPG, SSH, GitHub web-based"
            echo ""
            echo "**How to sign commits (GPG):**"
            echo '```bash'
            echo "# Configure GPG key"
            echo "git config --global user.signingkey YOUR_GPG_KEY_ID"
            echo "git config --global commit.gpgsign true"
            echo '```'
            echo ""
            echo "**How to sign commits (SSH):**"
            echo '```bash'
            echo "# Configure SSH signing"
            echo "git config --global gpg.format ssh"
            echo "git config --global user.signingkey ~/.ssh/id_ed25519.pub"
            echo "git config --global commit.gpgsign true"
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

          # Set output for other steps
          {
            echo "unsigned_count=$UNSIGNED"
            echo "signed_count=$SIGNED"
            echo "total_count=$TOTAL"
          } >> "$GITHUB_OUTPUT"

      - name: Add PR comment for unsigned commits
        if: github.event_name == 'pull_request' && steps.verify.outputs.unsigned_count != '0'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const unsigned = '${{ steps.verify.outputs.unsigned_count }}';
            const total = '${{ steps.verify.outputs.total_count }}';

            const body = `## üîê Commit Signature Verification

            ‚ö†Ô∏è **Warning**: ${unsigned} out of ${total} commits in this PR are not signed.

            ### Why sign commits?

            - ‚úÖ Cryptographic proof of authorship
            - ‚úÖ Prevents commit forgery
            - ‚úÖ Improves supply chain security
            - ‚úÖ Required by many security policies

            ### Supported Signature Types

            This workflow accepts **GPG**, **SSH**, and **GitHub web-based** signatures.

            ### Option 1: Sign with SSH (Recommended - Easiest)

            \`\`\`bash
            # Configure SSH signing (uses your existing SSH key)
            git config --global gpg.format ssh
            git config --global user.signingkey ~/.ssh/id_ed25519.pub
            git config --global commit.gpgsign true

            # Add your SSH key to GitHub
            # Settings ‚Üí SSH and GPG keys ‚Üí New SSH key (select "Signing Key" as type)
            \`\`\`

            ### Option 2: Sign with GPG (Traditional)

            \`\`\`bash
            # Generate GPG key (if you don't have one)
            gpg --full-generate-key

            # List your keys
            gpg --list-secret-keys --keyid-format=long

            # Configure Git to use your key
            git config --global user.signingkey YOUR_GPG_KEY_ID
            git config --global commit.gpgsign true

            # Add your GPG key to GitHub
            # Settings ‚Üí SSH and GPG keys ‚Üí New GPG key
            gpg --armor --export YOUR_GPG_KEY_ID
            \`\`\`

            ### Option 3: GitHub Web-Based (Automatic)

            Commits made through GitHub's web interface are automatically signed.

            ---

            For more information, see:
            - [GitHub's guide on signing commits](https://docs.github.com/en/authentication/managing-commit-signature-verification)
            - [SSH commit signing](https://docs.github.com/en/authentication/managing-commit-signature-verification/about-commit-signature-verification#ssh-commit-signature-verification)

            ---

            <sub>ü§ñ This check helps maintain supply chain security but is not currently required.</sub>
            `;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Fail on unsigned commits
        if: github.event_name == 'pull_request' && steps.verify.outputs.unsigned_count != '0'
        run: |
          echo "::error::All commits must be GPG/SSH signed. Found ${{ steps.verify.outputs.unsigned_count }} unsigned commits."
          echo "::error::See workflow summary for signing instructions."
          exit 1
