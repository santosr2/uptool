name: Self Update Check

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      create-pr:
        description: 'Create PR instead of issue'
        type: boolean
        default: false
  push:
    branches: [main]
    paths:
      - '.pre-commit-config.yaml'
      - 'mise.toml'
      - 'go.mod'
      - 'go.sum'
      - "testdata/**"
      - "examples/**"
      - "!examples/**/*.md"
      - "!examples/**/uptool*.yaml"

# Cancel in-progress runs for the same workflow on the same ref
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  check-dependencies:
    name: Check Dependencies with uptool
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Setup mise
        uses: ./.github/actions/setup-mise

      - name: Build uptool from source
        run: |
          echo "Building uptool from current source for dogfooding..."
          mise run build

          # Add to PATH so the action can use it
          echo "$PWD/dist" >> "$GITHUB_PATH"

          # Verify
          ./dist/uptool version

      - name: Determine action mode
        id: mode
        run: |
          # For scheduled runs, create an issue for manual review
          # For workflow_dispatch with create-pr=true, create a PR
          # For push events, just check and report
          if [ "${{ github.event_name }}" == "schedule" ]; then
            echo "mode=issue" >> "$GITHUB_OUTPUT"
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ inputs.create-pr }}" == "true" ]; then
            echo "mode=pr" >> "$GITHUB_OUTPUT"
          else
            echo "mode=check" >> "$GITHUB_OUTPUT"
          fi

      - name: Run uptool action (create issue)
        if: steps.mode.outputs.mode == 'issue'
        uses: ./
        with:
          token: ${{ steps.app-token.outputs.token }}
          command: plan
          skip-install: true
          create-issue: true
          issue-title: 'ðŸ”„ Dependency Updates Available'
          issue-labels: 'dependencies,automated,enhancement'

      - name: Run uptool action (create PR)
        if: steps.mode.outputs.mode == 'pr'
        uses: ./
        with:
          token: ${{ steps.app-token.outputs.token }}
          command: update
          skip-install: true
          create-pr: true
          pr-title: 'chore(deps): update dependencies'
          pr-branch: 'uptool/dependency-updates-${{ github.run_number }}'

      - name: Run uptool action (check only)
        if: steps.mode.outputs.mode == 'check'
        uses: ./
        with:
          token: ${{ steps.app-token.outputs.token }}
          command: plan
          skip-install: true

  summary:
    name: Dependency Check Summary
    needs: [check-dependencies]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Generate summary
        run: |
          {
            echo "## ðŸ” Self Update Check Complete"
            echo ""
            echo "**Status**: ${{ needs.check-dependencies.result }}"
            echo ""
            echo "### What was checked?"
            echo "- âœ… \`.pre-commit-config.yaml\` (pre-commit hooks)"
            echo "- âœ… \`mise.toml\` (runtime versions - detection only)"
            echo "- âœ… \`go.mod\` and \`go.sum\` (Go dependencies)"
            echo ""
            echo "### Notes"
            echo "- This workflow uses uptool to check its own dependencies (dogfooding)"
            echo "- Runs weekly on Mondays at 9:00 AM UTC"
            echo "- Creates an issue when updates are found (scheduled runs)"
            echo "- Can create a PR via workflow_dispatch with \`create-pr: true\`"
            echo ""
            echo "ðŸ“š See workflow run for detailed results"
          } >> "$GITHUB_STEP_SUMMARY"
