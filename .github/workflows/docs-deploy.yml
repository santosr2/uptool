name: Documentation

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'README.md'
      - 'CONTRIBUTING.md'
      - 'CHANGELOG.md'
      - '.github/workflows/docs-deploy.yml'
      - '**.go'
    tags:
      - 'v*'  # Always deploy versioned docs on release tags
  pull_request:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'README.md'
      - 'CONTRIBUTING.md'
      - '.github/workflows/docs-deploy.yml'
  workflow_dispatch:

permissions:
  contents: write  # Required for mike to push to gh-pages branch
  pages: write
  id-token: write
  pull-requests: write

# Don't cancel in-progress deployments to avoid partial deployments
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  build-docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0 # Fetch all history for accurate versioning

      - name: Setup mise
        uses: ./.github/actions/setup-mise

      - name: Install MkDocs and plugins
        run: |
          pip install --user -r docs/requirements.txt

      - name: Determine documentation version
        id: doc_version
        run: |
          # Determine version for build
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            TAG_VERSION="${GITHUB_REF#refs/tags/v}"
            echo "uptool_version=v${TAG_VERSION}" >> "$GITHUB_OUTPUT"
            echo "üìå Release version: v${TAG_VERSION}" >> "$GITHUB_STEP_SUMMARY"
          elif [[ "${GITHUB_REF}" == refs/heads/main ]]; then
            echo "uptool_version=main" >> "$GITHUB_OUTPUT"
            echo "üìå Development version: main" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "uptool_version=preview" >> "$GITHUB_OUTPUT"
            echo "üìå Preview build" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Update MkDocs version variable
        run: |
          VERSION="${{ steps.doc_version.outputs.uptool_version }}"
          sed -i "s/uptool_version: .*/uptool_version: ${VERSION}/" mkdocs.yml
          echo "‚úÖ Updated mkdocs.yml with version: ${VERSION}"

      - name: Generate API documentation
        run: |
          mkdir -p docs/api
          gomarkdoc --output docs/api/README.md ./...

      - name: Build CLI documentation
        run: |
          mkdir -p dist
          go build -o dist/uptool ./cmd/uptool
          mkdir -p docs/cli
          ./dist/uptool --help > docs/cli/commands.md || echo "# CLI Commands" > docs/cli/commands.md

      - name: Build MkDocs site
        run: |
          mkdocs build --strict
          {
            echo "‚úÖ MkDocs site built successfully"
            echo "**Pages generated:** $(find site -name '*.html' | wc -l)"
            echo "**Version:** ${{ steps.doc_version.outputs.uptool_version }}"
          } >> "$GITHUB_STEP_SUMMARY"

  deploy-docs:
    name: Deploy Documentation
    needs: build-docs
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for mike to push to gh-pages
    environment:
      name: github-pages
      url: https://santosr2.github.io/uptool/
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Setup mise
        uses: ./.github/actions/setup-mise

      - name: Install MkDocs and plugins
        run: |
          pip install --user -r docs/requirements.txt

      - name: Determine deployment version
        id: deploy_version
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            # For version tags (e.g., v0.2.0), deploy as "0.2" with "latest" alias
            TAG_VERSION="${GITHUB_REF#refs/tags/v}"
            MAJOR_MINOR=$(echo "$TAG_VERSION" | cut -d. -f1,2)
            {
              echo "version=${MAJOR_MINOR}"
              echo "alias=latest"
              echo "is_release=true"
              echo "uptool_version=v${TAG_VERSION}"
            } >> "$GITHUB_OUTPUT"
            echo "üìå Deploying version: ${MAJOR_MINOR} (latest)" >> "$GITHUB_STEP_SUMMARY"
          elif [[ "${GITHUB_REF}" == refs/heads/main ]]; then
            # For main branch, deploy as "main"
            {
              echo "version=main"
              echo "alias=dev"
              echo "is_release=false"
              echo "uptool_version=main"
            } >> "$GITHUB_OUTPUT"
            echo "üìå Deploying version: main (dev)" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Update MkDocs version variable
        run: |
          VERSION="${{ steps.deploy_version.outputs.uptool_version }}"
          sed -i "s/uptool_version: .*/uptool_version: ${VERSION}/" mkdocs.yml
          echo "‚úÖ Updated mkdocs.yml with version: ${VERSION}"

      - name: Configure Git for mike
        run: |
          git config user.name "santosr2[bot]"
          git config user.email "${{ vars.BOT_USER_ID }}+santosr2[bot]@users.noreply.github.com"

      - name: Generate API documentation
        run: |
          mkdir -p docs/api
          gomarkdoc --output docs/api/README.md ./...

      - name: Build CLI documentation
        run: |
          mkdir -p dist
          go build -o dist/uptool ./cmd/uptool
          mkdir -p docs/cli
          ./dist/uptool --help > docs/cli/commands.md || echo "# CLI Commands" > docs/cli/commands.md

      - name: Deploy versioned docs with mike
        run: |
          VERSION="${{ steps.deploy_version.outputs.version }}"
          ALIAS="${{ steps.deploy_version.outputs.alias }}"
          IS_RELEASE="${{ steps.deploy_version.outputs.is_release }}"

          # Deploy with mike
          if [ -n "$ALIAS" ]; then
            echo "üöÄ Deploying version: $VERSION (alias: $ALIAS)"
            mike deploy --push --update-aliases "$VERSION" "$ALIAS"
          else
            echo "üöÄ Deploying version: $VERSION"
            mike deploy --push "$VERSION"
          fi

          # Set default version
          # - For releases: set the release version as default
          # - For main branch: set main as default (until a release is made)
          if [ "$IS_RELEASE" = "true" ]; then
            echo "üìå Setting $VERSION as default version (stable release)"
            mike set-default --push "$VERSION"
          else
            echo "üìå Setting $VERSION as default version (development)"
            mike set-default --push "$VERSION"
          fi

          # Deployment summary
          {
            echo "## üöÄ Documentation Deployed"
            echo ""
            echo "**Version:** $VERSION"
            echo "**Alias:** ${ALIAS:-none}"
            echo "**Default:** true"
            echo ""
            echo "üåç **Live at**: https://santosr2.github.io/uptool/"
            echo "üìñ **All versions**: https://santosr2.github.io/uptool/versions/"
          } >> "$GITHUB_STEP_SUMMARY"

  preview-comment:
    name: Preview Deployment Comment
    needs: build-docs
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Comment on PR with preview info
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const body = `## üìö Documentation Preview

            The documentation has been built successfully for this PR.

            ### Preview Deployment

            ‚ö†Ô∏è **Note**: Preview deployments to separate URLs are not currently configured.
            To enable preview deployments, set up a preview environment in your repository settings.

            ### What's Included

            - ‚úÖ API Documentation
            - ‚úÖ CLI Reference
            - ‚úÖ User Guides
            - ‚úÖ Updated README/CONTRIBUTING

            ### Manual Preview

            To preview the documentation locally:

            \`\`\`bash
            # Check out this PR
            gh pr checkout ${{ github.event.pull_request.number }}

            # Build and serve docs
            mise run docs-serve
            \`\`\`

            ---

            <sub>ü§ñ Documentation will be automatically deployed to production when this PR is merged.</sub>
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Documentation Preview')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  validate-docs:
    name: Validate Documentation
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Check for broken markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@d53a906aa6b22b8979d33bc86170567e619495ec # v1.0.15
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/markdown-link-check-config.json'
        continue-on-error: true

      - name: Validate README
        run: |
          {
            echo "## üìã Documentation Validation"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

          # Check README exists
          if [ ! -f README.md ]; then
            echo "‚ùå README.md not found" >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi

          # Check minimum length
          README_LINES=$(wc -l < README.md)
          if [ "$README_LINES" -lt 20 ]; then
            echo "‚ö†Ô∏è README.md seems too short ($README_LINES lines)" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "‚úÖ README.md exists ($README_LINES lines)" >> "$GITHUB_STEP_SUMMARY"
          fi

          # Check for essential sections
          SECTIONS=("Installation" "Usage" "Features")
          for section in "${SECTIONS[@]}"; do
            if grep -qi "$section" README.md; then
              echo "‚úÖ Section found: $section" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "‚ö†Ô∏è Section missing: $section" >> "$GITHUB_STEP_SUMMARY"
            fi
          done

      - name: Check documentation completeness
        run: |
          {
            echo ""
            echo "### Documentation Files"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

          # List all markdown files
          if [ -d docs ]; then
            find docs -name "*.md" -type f | while read -r file; do
              echo "- üìÑ $file" >> "$GITHUB_STEP_SUMMARY"
            done
          else
            echo "‚ö†Ô∏è docs/ directory not found" >> "$GITHUB_STEP_SUMMARY"
          fi
